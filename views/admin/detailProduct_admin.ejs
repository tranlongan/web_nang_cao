<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web bán hàng</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <!-- Google Fonts Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="/mdbootstrap/css/bootstrap.min.css">
    <!-- Material Design Bootstrap -->
    <link rel="stylesheet" href="/mdbootstrap/css/mdb.min.css">
    <!-- Your custom styles (optional) -->
    <link rel="stylesheet" href="/mdbootstrap/css/style.css">
</head>

<body>

<!--    row 1-->
<div class="row">
    <!--        nút home-->
    <a class="navbar-brand" href="/admin/loadCategoryAndHome?id_admin=<%= id_admin %>">Trang chủ</a>
    <div class="float-right">
        <a class="navbar-brand" href="/loginAdmin">Đăng xuất</a>
    </div>
</div>
<!-- Bắt đầu code-->
<div style="background-color: gainsboro">
    <% result.map((row) => { %>
        <div class="container" style="background-color: white">
            <div class="row">
                <div class="col-4">
                    <img style="width: 356px; height: 280px" alt="Card image cap" src="<%= row.link_image %>">
                </div>
                <div class="col-8" style="border-left: 1px solid #aaaaaa">
                    <div style="font-size: 21px"><%= row.name_product %></div>

                    <div class="row">
                        <div class="col-7 m-1">
                            <div style="background-color: #f0f0f0; font-size: 24px"><%= Intl.NumberFormat().format(row.cost) %>
                                đ
                            </div>
                            <hr/>
                            <div> Giao đến
                                <u style="font-weight: bolder; font-size: 15px">
                                    Q.Ngũ Hành Sơn, P.Hòa Quý, Đà Nẵng
                                </u> - <a href="#!">ĐỔI ĐỊA CHỈ</a>
                            </div>
                            <div style="border: 1px solid #aaaaaa; border-radius: 10px">
                                <div class="ml-1" style="font-weight: bolder">GIAO TIÊU CHUẨN</div>
                                <div class="ml-3" style="font-weight: bolder; color: green">tháng 11 năm 2020</div>
                                <div class="ml-3">Vận chuyển: <font style="font-weight: bolder; color: green">Miễn
                                        phí </font><strike>44.000đ</strike></div>
                            </div>
                            <hr/>
                            <div>Số lượng</div>
                            <div>
                                <button style="font-weight: bolder; font-size: 16px" class="btn">-</button>
                                <input type="text" id="numbers" name="numbers" value="1"
                                       style="width: 40px; text-align: center">
                                <button style="font-weight: bolder; font-size: 16px" class="btn">+</button>
                            </div>
                            <div>
                                <button type="button" style="font-size: 16px"
                                        class="btn btn-danger" data-toggle="modal" data-target="#modalAbandonedCart">
                                    Chọn mua
                                </button>

                                <!-- Modal: modalAbandonedCart-->
                                <div class="modal fade" id="modalAbandonedCart" tabindex="-1" role="dialog"
                                     aria-labelledby="myModalLabel"
                                     aria-hidden="true" data-backdrop="false">
                                    <div class="modal-dialog modal-notify modal-info" role="document">
                                        <!--Content-->
                                        <div class="modal-content">
                                            <!--Header-->
                                            <div class="modal-header">
                                                <p class="heading">Giỏ hàng</p>
                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                    <span aria-hidden="true" class="white-text">&times;</span>
                                                </button>
                                            </div>

                                            <!--Body-->
                                            <div class="modal-body">
                                                <div class="row">
                                                    <div class="col-3">
                                                        <p class="text-center">
                                                            <i class="fas fa-shopping-cart fa-4x"></i>
                                                        </p>
                                                    </div>
                                                    <div class="col-9">
                                                        <p>Bạn phải dùng tài khoản người dùng để đặt hàng</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <!--Footer-->
                                            <div class="modal-footer justify-content-center">
                                                <a type="button" class="btn btn-outline-info waves-effect"
                                                   data-dismiss="modal">Cancel</a>
                                            </div>
                                        </div>
                                        <!--/.Content-->
                                    </div>
                                </div>
                                <!-- Modal: modalAbandonedCart-->
                                <button class="btn btn-outline-blue">
                                    <div style="font-size: 11px">Trả góp qua thẻ tín dụng</div>
                                    <div style="font-size: 8px">Chỉ từ 1.000.000 đ/tháng</div>
                                </button>
                            </div>
                        </div>
                        <div style="border: 1px solid #aaaaaa; max-height: inherit; height: 50%" class="col-4 m-1">
                            <div>Cam kết chính hiệu bởi</div>
                            <div class="row pb-2" style="border-bottom: 1px solid #aaaaaa">
                                <div class="col-3">
                                    <img style="width: 50px; height: 50px; border-radius: 100%"
                                         src="/images/98f3f134f85cff2c6972c31777629aa0.png">
                                </div>
                                <div class="col-9">
                                    <div>Tiki Trading</div>
                                    <a href="#!">Xem shop</a>
                                </div>
                            </div>
                            <nav class="mt-2 nav" style="text-align: center">
                                <li class="nav-item mr-2" style="font-size: 12px">
                                    <img style="width: 20px"
                                         src="https://frontend.tikicdn.com/_desktop-next/static/img/icons/compensation.svg">
                                    <div>Hoàn tiền</div>
                                    <div><b>111%</b></div>
                                    <div><u>nếu giả</u></div>
                                </li>
                                <li class="nav-item mr-2" style="font-size: 12px">
                                    <img src="https://frontend.tikicdn.com/_desktop-next/static/img/pdp_revamp_v2/guarantee.svg">
                                    <div>Mở hộp kiểm tra</div>
                                    <div>kiểm tra</div>
                                    <div>nhận hàng</div>
                                </li>
                                <li class="nav-item" style="font-size: 12px">
                                    <img style="width: 20px"
                                         src="https://frontend.tikicdn.com/_desktop-next/static/img/icons/refund.svg">
                                    <div>Đổi trả trong</div>
                                    <div><b>20 ngày</b></div>
                                    <div>nếu sp lỗi</div>
                                </li>
                            </nav>
                        </div>
                    </div>

                </div>

            </div>
            <div><%- row.description %></div>
        </div>
    <% }) %>
    <div class="container">
        <h3>Khách hàng nhận xét</h3>
    </div>
    <div id="comments">
        <% result_comment.map((row1)=>{ %>
            <div id="<%= row1.id %>" class="container mb-1"
                 style="background-color: white; border-bottom: 1px solid #aaaaaa">
                <div>
                    <div class="row">
                        <div class="col-1">
                            <img style="border-radius:100%; width: 80px" src="/images/unnamed.png">
                        </div>
                        <div class="col-5">
                            <div style="font-weight: bolder" class="mt-3">
                                <%= row1.name_user %>
                            </div>
                            <div style="color: #aaaaaa">
                                Nhận xét vào <%= row1.time_comment %>
                            </div>
                        </div>
                    </div>
                    <div>
                        <i class='fas fa-star yellow-text'> </i>
                        <i class='fas fa-star yellow-text'> </i>
                        <i class='fas fa-star yellow-text'> </i>
                        <i class='fas fa-star yellow-text'> </i>
                        <i class='fas fa-star yellow-text'> </i>
                    </div>
                    <div class="bg-info mb-2">
                        <%= row1.comment_content %>
                    </div>
                    <div class="ml-3 bg-light" id="reply1"></div>
                    <div>
                        <button id="idBtnReply" type="button" style="border: 0;background-color: Transparent"
                                onclick="btnReply(<%= row1.id_of_product %>,<%= row1.id %>)">Trả lời
                        </button>
                    </div>
                    <div id="divInputReply<%= row1.id %>" style="display: none"></div>
                </div>

            </div>
        <% }) %>
    </div>
    <div class="container mt-2 mb-4">
        <div class="row">
            <input style="max-width: inherit; width: 85%" type="text" id="data_input_answer" name="data_input_answer"
                   class="pl-3" placeholder="Hãy đặt câu hỏi liên quan đến sản phẩm...">
            <span>
                <% result.map((row2)=>{ %>
                    <button type="button" onclick="submitComment(<%= id_admin %>,<%= row2.id %>)"
                            class="btn btn-amber pt-2 pb-2">Gửi nhận xét</button>
                <% }) %>
            </span>
        </div>
    </div>
</div>

<!-- Kết thúc code-->


<!--ckeditor-->
<script src="https://cdn.ckeditor.com/ckeditor5/20.0.0/classic/ckeditor.js"></script>
<!-- jQuery -->
<script type="text/javascript" src="/mdbootstrap/js/jquery.min.js"></script>
<!-- Bootstrap tooltips -->
<!--<script type="text/javascript" src="/mdbootstrap/js/popper.min.js"></script>-->
<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="/mdbootstrap/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script type="text/javascript" src="/mdbootstrap/js/mdb.min.js"></script>
<!--axios-->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!--phần bình luận-->
<script>
    // nút bình luận
    const submitComment = async (id_admin, id_product) => {
        const data_input_answer = document.getElementById("data_input_answer").value;
        const formData = new FormData();
        formData.append("data_input_answer", data_input_answer);
        try {
            const result = await axios.post(`/addComment?id_admin=${id_admin}&id_product=${id_product}`, formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });
            const body = result.data;
            if (body.msg === 'ok') {
                window.open(`/user/detailProduct_User?id_admin=${id_admin}&id_product=${id_product}`, `_self`);
            }
        } catch (e) {
            console.error(e);
        }
    }

    <!--nút trả lời-->
    const btnReply = async (id_of_product, id_of_comment) => {
        try {
            const divReply = document.getElementById("divInputReply" + id_of_comment);
            if (divReply.style.display === "none") {
                let html = '';
                html += '<div class="d-flex flex-row mt-2">\n' +
                    '    <input class="form-control mt-2 ml-2 w-75" id="text_area_reply' + id_of_comment + '">\n' +
                    '<span>\n' +
                    '    <button class="btn btn-amber" type="button" onclick="submitReply(' + id_of_product + ',' + id_of_comment + ')">Gửi\n' +
                    '        phản hồi\n' +
                    '    </button>\n' +
                    '</span>'
                '</div>';
                divReply.innerHTML = html;
                divReply.style.display = "block";

            } else {
                divReply.style.display = "none";
            }
        } catch (e) {
            console.error(e);
        }
    }

    // nút gửi câu trả lời
    const submitReply = async (id_of_product, id_of_comment) => {
        try {
            const text_area_reply = document.querySelector("#text_area_reply" + id_of_comment).value;
            const formData = new FormData();
            formData.append("text_area_reply", text_area_reply);
            const result = await axios.post(`/addReplyComment?id_admin=<%= id_admin %>&id_product=${id_of_product}&id_comment=${id_of_comment}`, formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });
            const body = result.data;
            if (body.msg === 'ok') {
                window.open(`/user/detailProduct_User?id_admin=<%= id_admin %>&id_product=${id_of_product}`, `_self`);
            }
        } catch (e) {
            console.error(e);
        }
    }

    <!--load các nội dung reply comment-->
    (async () => {
        try {
            const id_comment = document.getElementById("reply1").getAttribute('value');

            const result = await axios.get(`/getReplyComment?id_admin=<%= id_admin %>&id_comment=${id_comment}`);
            const body = result.data;

            console.log(body);
            Array.from(document.getElementById("comments").children).forEach((comment) => {
                console.log(comment);
                const replies = body.result_reply.filter((reply) => {
                    return reply.id_of_comment == comment.id
                });
                replies.forEach((reply) => {
                    comment.querySelector("#reply1").innerHTML += '<blockquote class="blockquote">\n' +
                        '                <p class="mb-0">' + reply.content_reply + '</p>\n' +
                        '                <footer class="blockquote-footer mb-0"><u style="font-weight: bolder">' + reply.name_user + '</u>' +
                        '<cite title="Source Title">' +
                        '    trả lời vào lúc ' + reply.date_reply +
                        '</cite>\n' +
                        '                </footer>\n' +
                        '            </blockquote>';
                })
            })
        } catch (e) {
            console.log(e);
        }
    })()
</script>

</body>
</html>